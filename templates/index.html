<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSPB RANK CHANGER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #020617; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .flip-container { transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .flipped { transform: rotateY(180deg); }
        .modal-enter { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-exit { animation: popOut 0.2s ease-in forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes popOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.95); } }
    </style>
</head>
<body class="text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-[380px] bg-[#0f172a] rounded-2xl border border-slate-800 shadow-2xl relative flex flex-col h-[650px] overflow-hidden">
        
        <!-- Header -->
        <div class="px-6 py-5 flex justify-between items-center bg-[#0f172a] z-20 border-b border-slate-800/50 flex-shrink-0">
            <div>
                <h1 class="text-lg font-extrabold text-white tracking-tight">RANK CHANGER</h1>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-pink-500 animate-pulse"></span>
                    <p class="text-[10px] text-slate-400 font-bold tracking-wider">ALL FORMAT TOOLS</p>
                </div>
            </div>
            <button onclick="toggleMenu()" class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors flex items-center justify-center">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>

        <!-- Flipper Content -->
        <div class="flex-1 relative perspective-1000 overflow-hidden m-4 mb-2">
            <div id="cardFlipper" class="relative w-full h-full transform-style-3d flip-container">
                
                <!-- FRONT: LIST -->
                <div class="absolute inset-0 backface-hidden bg-[#020617] rounded-xl border-2 border-slate-800 flex flex-col">
                    <div id="emptyState" class="flex-1 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-900/50 transition-colors group" onclick="document.getElementById('fileInput').click()">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-500 group-hover:text-pink-500"></i>
                        </div>
                        <p class="text-xs font-bold text-slate-400">TAP TO UPLOAD</p>
                        <p class="text-[10px] text-slate-600 mt-1 uppercase">PNG, JPG, DDS, PSD, ZIP</p>
                    </div>

                    <div id="listContainer" class="hidden flex-col h-full">
                        <div class="p-3 bg-slate-900/50 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                            <span class="text-xs font-bold text-slate-400">FILE LIST</span>
                            <button onclick="document.getElementById('fileInput').click()" class="text-[10px] bg-slate-800 px-2 py-1 rounded text-white hover:bg-pink-600 transition">+ ADD</button>
                        </div>
                        <div id="fileListScroll" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                </div>

                <!-- BACK: PREVIEW & SETTINGS -->
                <div class="absolute inset-0 backface-hidden rotate-y-180 bg-[#020617] rounded-xl border-2 border-pink-500/30 flex flex-col overflow-hidden">
                    <div class="p-3 bg-slate-900/80 border-b border-slate-800 flex justify-between items-center z-10 flex-shrink-0">
                        <span class="text-xs font-bold text-white truncate max-w-[120px]" id="previewTitle">file.png</span>
                        
                        <div class="flex gap-2">
                            <!-- TOMBOL RESIZE HANYA ADA DISINI -->
                            <button onclick="toggleResize()" class="w-6 h-6 rounded bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center hover:bg-pink-600 transition-colors" title="Resize Image">
                                <i class="fa-solid fa-ruler-combined text-[10px]"></i>
                            </button>
                            <!-- TOMBOL CLOSE -->
                            <button onclick="flipBack()" class="w-6 h-6 rounded bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center hover:bg-red-500 transition-colors">
                                <i class="fa-solid fa-xmark text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center p-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PHBhdGggZD0iTTAgMEg1VjVIMFpNNSA1SDEwVjEwSDVaIiBmaWxsPSIjMWUyOTNiIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')] relative">
                        <img id="previewImage" class="max-w-full max-h-full object-contain shadow-lg rounded" alt="Preview">
                        <div id="previewIcon" class="hidden text-center"><i class="fa-solid fa-file-zipper text-5xl text-pink-500"></i></div>
                        
                        <!-- Indikator Resize Active -->
                        <div id="resizeBadge" class="hidden absolute bottom-4 bg-pink-500/90 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg">
                            RESIZED
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="p-4 pt-0 flex-shrink-0 bg-[#0f172a]">
            
            <div class="mb-3">
                <div class="flex justify-between items-end mb-1 px-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Target Format</label>
                </div>
                
                <div class="relative">
                    <select id="formatSelect" class="w-full bg-[#020617] text-white text-xs font-bold border border-slate-700 rounded-xl py-3 px-4 appearance-none focus:border-pink-500 focus:outline-none uppercase tracking-wider cursor-pointer hover:border-slate-500 transition-colors">
                        <option value="bmp">BMP (CS 1.6)</option>
                        <option value="tga">TGA (VGUI)</option>
                        <option value="png">PNG (HD)</option>
                        <option value="jpg">JPG</option>
                        <option value="ico">ICO</option>
                        <option value="tiff">TIFF</option>
                        <option value="webp">WEBP</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
            </div>

            <!-- Main Button -->
            <button id="actionBtn" onclick="handleMainAction()" class="w-full bg-[#db2777] hover:bg-[#be185d] disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95 uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                <i class="fa-solid fa-bolt"></i>
                <span>CONVERT .BMP</span>
            </button>
        </div>

        <input type="file" id="fileInput" class="hidden" multiple accept="image/*,.zip,.dds,.tga,.psd,.ico,.tiff">
    </div>

    <!-- RESIZE MODAL (POP UP) -->
    <div id="resizeOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center" onclick="toggleResize()">
        <div class="bg-[#0f172a] w-64 rounded-2xl border border-slate-700 p-5 text-center transform scale-95 transition-all shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-white font-bold mb-4 tracking-widest text-sm border-b border-slate-800 pb-3">RESIZE SETTINGS</h2>
            
            <div class="flex items-center gap-2 mb-4">
                <div class="flex-1">
                    <label class="text-[10px] text-slate-500 font-bold block mb-1">WIDTH</label>
                    <input type="number" id="widthInput" placeholder="Auto" class="w-full bg-[#020617] border border-slate-700 rounded-lg p-2 text-white text-center text-sm focus:border-pink-500 outline-none">
                </div>
                <span class="text-slate-600 mt-4">x</span>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-500 font-bold block mb-1">HEIGHT</label>
                    <input type="number" id="heightInput" placeholder="Auto" class="w-full bg-[#020617] border border-slate-700 rounded-lg p-2 text-white text-center text-sm focus:border-pink-500 outline-none">
                </div>
            </div>
            
            <!-- DUA TOMBOL PILIHAN -->
            <div class="space-y-2">
                <button onclick="applyResize('single')" class="w-full bg-[#db2777] hover:bg-pink-600 text-white font-bold py-2 rounded-xl text-xs">APPLY (THIS FILE)</button>
                <button onclick="applyResize('all')" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-pink-500 text-white font-bold py-2 rounded-xl text-xs">APPLY TO ALL FILES</button>
            </div>
            
            <button onclick="resetResize()" class="mt-3 text-[10px] text-slate-500 hover:text-white underline">RESET TO ORIGINAL</button>
        </div>
    </div>

    <!-- MENU MODAL -->
    <div id="menuOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center" onclick="toggleMenu()">
        <div id="menuBox" class="bg-[#0f172a] w-64 rounded-2xl border border-slate-700 p-5 text-center transform scale-95 opacity-0 transition-all shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-white font-bold mb-5 tracking-widest text-sm border-b border-slate-800 pb-3">MENU</h2>
            <a href="https://www.youtube.com/@yasaaoursea" target="_blank" class="flex items-center justify-center gap-3 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl text-xs mb-3 transition-colors"><i class="fa-brands fa-youtube text-lg"></i> YOUTUBE</a>
            <a href="https://sociabuzz.com/yasaaoursea/support" target="_blank" class="flex items-center justify-center gap-3 w-full bg-[#020617] border border-slate-700 hover:border-pink-500 text-white font-bold py-3 rounded-xl text-xs mb-3 transition-colors"><i class="fa-solid fa-heart text-pink-500"></i> SUPPORT / DONATE</a>
            <button onclick="toggleMenu()" class="text-slate-500 text-xs font-bold mt-2 hover:text-white">CLOSE</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const actionBtn = document.getElementById('actionBtn');
        const formatSelect = document.getElementById('formatSelect');
        const flipper = document.getElementById('cardFlipper');
        const previewImg = document.getElementById('previewImage');
        const previewIcon = document.getElementById('previewIcon');
        const previewTitle = document.getElementById('previewTitle');
        const resizeOverlay = document.getElementById('resizeOverlay');
        const resizeBadge = document.getElementById('resizeBadge');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');

        let filesData = []; 
        let activeIndex = -1; // Menyimpan index file yang sedang dibuka di preview
        let isProcessing = false;
        let isProcessDone = false;

        // --- RESIZE LOGIC (UPDATED) ---
        function toggleResize() {
            // Load current file settings into inputs when opening
            if (resizeOverlay.classList.contains('hidden') && activeIndex > -1) {
                const current = filesData[activeIndex].resize || { w: '', h: '' };
                widthInput.value = current.w;
                heightInput.value = current.h;
            }
            resizeOverlay.classList.toggle('hidden');
        }

        function applyResize(scope) {
            const w = widthInput.value;
            const h = heightInput.value;
            const resizeVal = (w && h) ? { w: w, h: h } : null;

            if (scope === 'all') {
                // Terapkan ke SEMUA file
                filesData.forEach(f => f.resize = resizeVal);
                alert("Resize settings applied to ALL files!");
            } else {
                // Terapkan ke file SAAT INI saja
                if (activeIndex > -1) {
                    filesData[activeIndex].resize = resizeVal;
                }
            }
            
            // Update Badge di Preview
            updateResizeBadge();
            toggleResize();
        }

        function resetResize() {
            widthInput.value = '';
            heightInput.value = '';
            applyResize('single'); // Reset hanya yang aktif (atau bisa logic lain)
        }

        function updateResizeBadge() {
            if (activeIndex > -1 && filesData[activeIndex].resize) {
                const r = filesData[activeIndex].resize;
                resizeBadge.classList.remove('hidden');
                resizeBadge.textContent = `RESIZED: ${r.w}x${r.h}`;
            } else {
                resizeBadge.classList.add('hidden');
            }
        }

        // --- UI & FLIP ---
        function updateBtnText() {
            if(isProcessing) return;
            if(isProcessDone) {
                actionBtn.innerHTML = `<i class="fa-solid fa-file-zipper"></i> <span>DOWNLOAD ALL ZIP</span>`;
                actionBtn.classList.replace('bg-[#db2777]', 'bg-green-600');
                actionBtn.classList.replace('hover:bg-[#be185d]', 'hover:bg-green-700');
            } else {
                const fmt = formatSelect.value.toUpperCase();
                const span = actionBtn.querySelector('span');
                if(span) span.innerText = `CONVERT .${fmt}`;
                actionBtn.classList.replace('bg-green-600', 'bg-[#db2777]');
                actionBtn.classList.replace('hover:bg-green-700', 'hover:bg-[#be185d]');
            }
        }
        formatSelect.addEventListener('change', updateBtnText);
        updateBtnText();

        function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('hidden'); }
        function flipBack() { flipper.classList.remove('flipped'); activeIndex = -1; }
        
        // --- FILE HANDLING ---
        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            if(newFiles.length) {
                isProcessDone = false;
                newFiles.forEach(f => {
                    filesData.push({ 
                        file: f, 
                        status: 'pending', 
                        id: Math.random().toString(36).substr(2, 9),
                        resize: null // Default tanpa resize
                    });
                });
                renderList();
                updateBtnText();
            }
        });

        function renderList() {
            const listScroll = document.getElementById('fileListScroll');
            const emptyState = document.getElementById('emptyState');
            const listContainer = document.getElementById('listContainer');

            if (filesData.length === 0) {
                emptyState.classList.remove('hidden');
                listContainer.classList.add('hidden');
                actionBtn.disabled = true;
                return;
            }
            emptyState.classList.add('hidden');
            listContainer.classList.remove('hidden');
            actionBtn.disabled = isProcessing;
            listScroll.innerHTML = ''; 

            filesData.forEach((item, index) => {
                const el = document.createElement('div');
                let borderClass = 'border-slate-800 hover:border-slate-600';
                let textClass = 'text-slate-500';
                let statusText = 'READY';
                let iconAction = `<button onclick="removeFile('${item.id}')" class="btn-action w-8 h-8 rounded bg-slate-800 hover:bg-red-500/20 hover:text-red-500 text-slate-500 flex items-center justify-center transition-colors z-10"><i class="fa-solid fa-trash"></i></button>`;

                // Cek jika ada resize
                if (item.resize) {
                    statusText = `READY (${item.resize.w}x${item.resize.h})`;
                    textClass = 'text-pink-400';
                }

                if (item.status === 'converting') {
                    borderClass = 'border-pink-500/50 shadow-[0_0_10px_rgba(236,72,153,0.1)]';
                    textClass = 'text-pink-400 animate-pulse';
                    statusText = 'PROCESSING...';
                    iconAction = `<i class="fa-solid fa-circle-notch fa-spin text-pink-500"></i>`;
                } else if (item.status === 'success') {
                    borderClass = 'border-green-500/30';
                    textClass = 'text-green-400';
                    statusText = 'DONE';
                    iconAction = `<a href="/download/${item.serverId}" class="btn-action w-8 h-8 rounded bg-green-600 hover:bg-green-500 text-white flex items-center justify-center z-10"><i class="fa-solid fa-download"></i></a>`;
                } else if (item.status === 'error') {
                    borderClass = 'border-red-500/30';
                    textClass = 'text-red-400';
                    statusText = 'FAILED';
                }

                el.className = `p-3 rounded-lg border bg-[#020617] flex items-center justify-between transition-all cursor-pointer group ${borderClass}`;
                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center flex-shrink-0 text-slate-500">${getFileIcon(item.file.name)}</div>
                        <div class="flex flex-col min-w-0">
                            <span class="text-xs font-bold text-gray-300 truncate w-32">${item.resultName || item.file.name}</span>
                            <span class="text-[10px] ${textClass} font-medium uppercase tracking-wide">${statusText}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">${iconAction}</div>
                `;
                el.onclick = (e) => {
                    if (e.target.closest('.btn-action')) return;
                    if (isProcessing) return; 
                    openPreview(index);
                };
                listScroll.appendChild(el);
            });
        }

        function getFileIcon(name) {
            if (name.endsWith('.zip')) return '<i class="fa-solid fa-file-zipper"></i>';
            if (name.endsWith('.dds')) return '<i class="fa-solid fa-cube"></i>';
            return '<i class="fa-regular fa-image"></i>';
        }

        function openPreview(index) {
            activeIndex = index; // Set aktif index untuk resize logic
            const item = filesData[index];
            previewTitle.textContent = item.file.name;
            updateResizeBadge(); // Cek apakah file ini punya setting resize

            if (item.file.type.startsWith('image/') || item.file.name.match(/\.(png|jpg|jpeg|webp|gif|bmp|ico)$/i)) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove('hidden');
                    previewIcon.classList.add('hidden');
                };
                reader.readAsDataURL(item.file);
            } else {
                previewImg.classList.add('hidden');
                previewIcon.classList.remove('hidden');
            }
            flipper.classList.add('flipped');
        }

        window.removeFile = function(id) {
            filesData = filesData.filter(f => f.id !== id);
            isProcessDone = false; 
            renderList();
            updateBtnText();
        }

        // --- MAIN PROCESS ---
        window.handleMainAction = async function() {
            if (isProcessDone) { downloadAllZip(); return; }
            startProcess();
        }

        async function startProcess() {
            isProcessing = true;
            renderList();
            actionBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> <span>WORKING...</span>';
            
            const queue = filesData.filter(f => f.status === 'pending');
            if (queue.length === 0) { isProcessing = false; renderList(); updateBtnText(); return; }

            for (let item of queue) {
                item.status = 'converting';
                renderList();
                try {
                    const fd = new FormData();
                    fd.append('file', item.file);
                    const up = await fetch('/upload', {method:'POST', body:fd}).then(r=>r.json());
                    
                    if(up.success) {
                        // KIRIM DATA RESIZE PER FILE
                        const payload = {
                            file_id: up.file_id, 
                            format: formatSelect.value,
                            width: item.resize ? item.resize.w : null,
                            height: item.resize ? item.resize.h : null
                        };
                        const conv = await fetch('/convert', {
                            method:'POST', 
                            headers:{'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        }).then(r=>r.json());
                        
                        if(conv.success) {
                            item.status = 'success';
                            item.serverId = up.file_id; 
                            item.resultName = conv.name;
                        } else { item.status = 'error'; }
                    } else { item.status = 'error'; }
                } catch(e) { item.status = 'error'; }
                renderList(); 
            }

            isProcessing = false;
            isProcessDone = true;
            updateBtnText();
        }

        async function downloadAllZip() {
            const successFiles = filesData.filter(f => f.status === 'success').map(f => f.serverId);
            if(successFiles.length === 0) return alert("No converted files to zip.");
            actionBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ZIPPING...';
            try {
                const response = await fetch('/download_zip', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_ids: successFiles })
                });
                if(response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = "Converted_Files.zip";
                    document.body.appendChild(a); a.click(); a.remove();
                } else { alert("Failed to create ZIP"); }
            } catch(e) { alert("Error downloading ZIP"); }
            updateBtnText();
        }
    </script>
</body>
</html>